{% extends "layouts/base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Dashboard - We go it!{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<section class="dashboard">

    <!-- 游댳 Tabla de Programaciones -->
    <div class="dashboard__card dashboard__card--full">
        <h3 class="dashboard__title">Programaci칩n de tours habilitados</h3>
        <table id="schedulesTable" class="display">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Programaci칩n</th>
                    <th>Cupos Vendidos</th>
                    <th>Cupos Disponibles</th>
                    <th>Venta Total</th>
                    <th>Pago Pendiente</th>
                </tr>
            </thead>
            <tbody>
                {% for s in schedules_actives %}
                <tr>
                    <td>{{ s.tour }}</td>
                    <td>{{ s.programacion }}</td>
                    <td>
                        {{ s.sold_spots }} de {{ s.capacity }}
                        <meter 
                            value="{{ s.sold_spots }}" 
                            min="0" 
                            max="{{ s.capacity }}" 
                            low="{{ s.capacity|mul:0.2 }}" 
                            high="{{ s.capacity|mul:0.7 }}" 
                            optimum="{{ s.capacity|mul:0.9 }}">
                            {{ s.sold_spots }} de {{ s.capacity }}
                        </meter>
                    </td>
                    <!-- CUPOS DISPONIBLES -->
                    <td>
                        {{ s.available_spots }} de {{ s.capacity }}
                        <meter 
                            value="{{ s.available_spots }}" 
                            min="0" 
                            max="{{ s.capacity }}" 
                            low="{{ s.capacity|mul:0.2 }}" 
                            high="{{ s.capacity|mul:0.7 }}" 
                            optimum="{{ s.capacity }}">
                            {{ s.available_spots }} de {{ s.capacity }}
                        </meter>
                    </td>
                    <td>${{ s.total_sales|floatformat:2 }}</td>
                    <td>${{ s.pending|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 游댳 Gr치ficas -->
    <div class="dashboard__card">
        <h3 class="dashboard__title">Total de Ventas</h3>
        <canvas id="totalVentasChart"></canvas>
    </div>

    <div class="dashboard__card">
        <h3 class="dashboard__title">Ventas Totales por Mes</h3>
        <canvas id="ventasPorMesChart"></canvas>
    </div>

    <div class="dashboard__card">
        <h3 class="dashboard__title">Total Ventas por Tour</h3>
        <canvas id="ventasPorTourChart"></canvas>
    </div>

    <div class="dashboard__card">
        <h3 class="dashboard__title">Deuda por Agencia</h3>
        <canvas id="deudaAgenciasChart"></canvas>
    </div>

    <div class="dashboard__card">
        <h3 class="dashboard__title">Reservas por Tour</h3>
        <canvas id="reservationsChart"></canvas>
    </div>

    <div class="dashboard__card">
        <h3 class="dashboard__title">Pagos por Fuente</h3>
        <canvas id="paymentsChart"></canvas>
    </div>

    <div class="dashboard__card">
        <h3 class="dashboard__title">Top 5 Tours por Pasajeros</h3>
        <canvas id="paxChart"></canvas>
    </div>

</section>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


{{ reservations_by_tour|json_script:"reservationsByTourData" }}
{{ payments_by_source|json_script:"paymentsBySourceData" }}
{{ pax_by_tour|json_script:"paxByTourData" }}
{{ deuda_agencias|json_script:"deudaAgenciasData" }}
{{ total_ventas|json_script:"totalVentasData" }}
{{ ventas_por_tour|json_script:"ventasPorTourData" }}
{{ ventas_por_mes|json_script:"ventasPorMesData" }}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 游댳 Inicializar DataTable
    $('#schedulesTable').DataTable();

    // 游댳 Parsear datos desde json_script
    const reservationsByTour = JSON.parse(document.getElementById('reservationsByTourData').textContent);
    const paymentsBySource = JSON.parse(document.getElementById('paymentsBySourceData').textContent);
    const paxByTour = JSON.parse(document.getElementById('paxByTourData').textContent);
    const deudaAgencias = JSON.parse(document.getElementById('deudaAgenciasData').textContent);
    const ventasPorMes = JSON.parse(document.getElementById('ventasPorMesData').textContent);

    // 游댳 Gr치fico: Reservas por Tour
    new Chart(document.getElementById('reservationsChart'), {
        type: 'bar',
        data: {
            labels: reservationsByTour.map(r => r.schedule__tour__tour_name),
            datasets: [{
                label: 'Reservas',
                data: reservationsByTour.map(r => r.total),
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
        },
        options: {
            responsive: true
        }
    });

    // 游댳 Gr치fico: Pagos por Fuente
    new Chart(document.getElementById('paymentsChart'), {
        type: 'pie',
        data: {
            labels: paymentsBySource.map(p => p.source),
            datasets: [{
                label: 'Pagos',
                data: paymentsBySource.map(p => p.total),
                backgroundColor: ['#36A2EB','#FF6384']
            }]
        },
        options: {
            responsive: true
        }
    });

    // 游댳 Gr치fico: Top 5 Tours por Pasajeros
    new Chart(document.getElementById('paxChart'), {
        type: 'line',
        data: {
            labels: paxByTour.map(t => t.schedule__tour__tour_name),
            datasets: [{
                label: 'Pasajeros',
                data: paxByTour.map(t => t.total_pax),
                borderColor: '#4BC0C0',
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true
        }
    });

    // 游댳 Gr치fico: Deuda por Agencia (solo agencias con deuda > 0)
    const deudaAgenciasFiltradas = deudaAgencias.filter(a => a.deuda > 0);

    new Chart(document.getElementById('deudaAgenciasChart'), {
        type: 'bar',
        data: {
            labels: deudaAgenciasFiltradas.map(a => a.agency || "Sin agencia"),
            datasets: [{
                label: 'Deuda',
                data: deudaAgenciasFiltradas.map(a => a.deuda),
                backgroundColor: 'rgba(255, 99, 132, 0.6)'
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y', // gr치fico horizontal para mejor legibilidad
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString(); // formato moneda
                        }
                    }
                }
            }
        }
    });

    // 游댳 Total de Ventas
    const totalVentas = JSON.parse(document.getElementById('totalVentasData').textContent);
    new Chart(document.getElementById('totalVentasChart'), {
        type: 'doughnut', // gr치fico tipo anillo
        data: {
            labels: ['Total Ventas'],
            datasets: [{
                label: 'COP',
                data: [totalVentas],
                backgroundColor: ['rgba(54, 162, 235, 0.6)']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });

    // 游댳 Ventas por Tour
    const ventasPorTour = JSON.parse(document.getElementById('ventasPorTourData').textContent);
    new Chart(document.getElementById('ventasPorTourChart'), {
        type: 'bar',
        data: {
            labels: ventasPorTour.map(v => v.tour),
            datasets: [{
                label: 'Ventas (COP)',
                data: ventasPorTour.map(v => v.ventas),
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { return '$' + value.toLocaleString(); }
                    }
                }
            }
        }
    });

    new Chart(document.getElementById('ventasPorMesChart'), {
        type: 'line',
        data: {
            labels: ventasPorMes.map(v => v.mes),
            datasets: [{
                label: 'Ventas (COP)',
                data: ventasPorMes.map(v => v.ventas),
                borderColor: '#FF6384',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});


</script>
{% endblock %}
