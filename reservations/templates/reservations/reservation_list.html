{% extends "layouts/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Reservas del Tour{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/reservations.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/payment_modal.css' %}">
{% endblock %}

{% block content %}
<div class="reservations-list-container">
    <div class="reservations-header">
        <h2 class="reservations-list-title">
            <span class="material-symbols-outlined">receipt_long</span>
            {% if general %}
                Listado General de Reservas
            {% else %}
                Reservas para {{ schedule.tour.tour_name }}
            {% endif %}
        </h2>
        {% if not general %}
        <a href="javascript:history.back()" class="btn-volver">
            <span class="material-symbols-outlined">arrow_back</span>
            Volver
        </a>
        {% if schedule.opened %}
        <a href="{% url 'tours:create_reservation' schedule.id %}" class="btn-crear-reserva">
            <span class="material-symbols-outlined">add_circle</span>
            Nueva Reserva
        </a>
        {% endif %}
        <a href="{% url 'tours:export_schedule_reservations_xls' schedule.id %}" class="btn-exportar">
            <span class="material-symbols-outlined">download</span>
        </a>
        {% endif %}
        {% if general %}
        <a href="{% url 'tours:export_reservations_xls' %}" class="btn-exportar">
            <span class="material-symbols-outlined">download</span>
        </a>
        {% endif %}
    </div>

    {% if not general %}
        <div class="schedule-info">
            <p><strong>Fecha:</strong> {{ schedule.date }}</p>
            <p><strong>Hora:</strong> {{ schedule.start_time }}</p>
        </div>
    {% endif %}

    <table id="reservationTable" class="display responsive nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Nombre Cliente</th>
                <th>Teléfono</th>
                {% if general %}
                <th>Tour</th>
                <th>Programación</th>
                {% endif %}
                <th>Cupos</th>
                <th>Total a Pagar</th>
                <th>Saldo Pendiente</th>
                <th>Agencia</th>
                <th>Estado</th>
                <th>Pagos</th>
                <th>Ver Pagos</th>
                <th>Pendiente Agencia</th>
                <th>Pendiente Cliente</th>
                {% if request.user.is_staff %}
                <th>Editar</th>
                <th>Eliminar</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for r in reservations %}
            <tr>
                <td>{{ r.customer_name }}</td>
                <td>{{ r.customer_phone|default:"N/A" }}</td>
                {% if general %}
                <td>{{ r.schedule.tour.tour_name }}</td>
                <td>{{ r.schedule.date|date:"d/m/y" }} {{ r.schedule.start_time|time:"H:i" }}</td>
                {% endif %}
                <td>{{ r.pax }}</td>
                <td>${{ r.total_to_pay|floatformat:0|intcomma }}</td>
                <td class="{% if r.pending_balance > 0 %}saldo-pendiente{% else %}saldo-pagado{% endif %}">
                    ${{ r.pending_balance|floatformat:0|intcomma }}
                </td>
                <td>{{ r.agency|default:"N/A" }}</td>
                <td>
                    <span class="status-badge {% if r.status == 'Reservado' and r.pending_balance > 0 %}status-pendiente{% else %}status-{{ r.status|lower }}{% endif %}">
                        {{ r.status }}
                    </span>
                </td>
                <td>
                    <button class="open-payment-modal" data-reservation="{{ r.id }}" title="Agregar Pago">
                        <span class="material-symbols-outlined">add_card</span>
                    </button>
                </td>
                <td>
                    {% if r.total_paid > 0 %}
                    <a href="{% url 'tours:reservation_payments_list' r.id %}" title="Ver Pagos">
                        <button class="btn-ver-pagos">
                            <span class="material-symbols-outlined">visibility</span>
                        </button>
                    </a>
                    {% endif %}
                </td>
                <td>${{ r.pending_agency_balance|floatformat:0|intcomma }}</td>
                <td>${{ r.pending_customer_balance|floatformat:0|intcomma }}</td>
                {% if request.user.is_staff %}
                <td>
                    <a href="{% url 'tours:update_reservation' r.id %}" title="Editar Reserva">
                        <button class="btn-ver-pagos">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                    </a>
                </td>
                <td>
                    {% if r.schedule.opened %}
                    <a href="{% url 'tours:delete_reservation' r.id %}" title="Eliminar Reserva" onclick="return confirm('¿Estás seguro de que quieres eliminar esta reserva?');">
                        <button class="btn-ver-pagos">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </a>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Pagos -->
<dialog id="paymentModal">
    <form id="paymentForm" method="post" action="{% url 'tours:add_payment' %}">
        {% csrf_token %}
        <h3>Registrar Pago</h3>
        <input type="hidden" name="reservation_id" id="reservationId">

        <div class="form-group">
            <label for="source">Fuente del pago</label>
            <select name="source" id="source" required>
                <option value="agency">Pagado a la Agencia</option>
                <option value="customer">Pagado directamente al Operador</option>
            </select>
        </div>

        <div class="form-group">
            <label for="amount">Monto</label>
            <input type="number" name="amount" id="amount" step="0.01" required>
        </div>

        <div class="form-group">
            <label for="note">Nota</label>
            <textarea name="note" id="note"></textarea>
        </div>

        <div class="modal-actions">
            <button type="submit" class="btn-primary">Guardar</button>
            <button type="button" id="closePaymentModal" class="btn-secondary">Cancelar</button>
        </div>
    </form>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    $('#reservationTable').DataTable({
        responsive: true,
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json',
        }
    });

    const modal = document.getElementById("paymentModal");
    const reservationInput = document.getElementById("reservationId");
    const closeBtn = document.getElementById("closePaymentModal");
    const form = document.getElementById("paymentForm");
    
    const messageBox = document.createElement("div");
    messageBox.id = "paymentMessage";
    form.prepend(messageBox);

    document.querySelector("#reservationTable").addEventListener("click", (e) => {
        const openBtn = e.target.closest(".open-payment-modal");
        if (openBtn) {
            const reservationId = openBtn.getAttribute("data-reservation");
            reservationInput.value = reservationId;
            
            form.reset();
            messageBox.innerText = "";
            messageBox.className = "";
            
            modal.showModal();
        }
    });

    closeBtn.addEventListener("click", () => modal.close());

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            }
        })
        .then(res => res.json())
        .then(data => {
            messageBox.innerText = data.message;
            messageBox.className = data.success ? "msg-success" : "msg-error";

            if (data.success) {
                setTimeout(() => {
                    modal.close();
                    location.reload();
                }, 1200);
            }
        })
        .catch(err => {
            console.error("Error:", err);
            messageBox.innerText = "Ocurrió un error inesperado.";
            messageBox.className = "msg-error";
        });
    });
});
</script>
{% endblock %}